openapi: 3.0.3
info:
  title: Agendamiento de Citas API
  version: 1.0.0
  description: >
    API para crear y listar citas. La confirmación se realiza de forma asíncrona
    (SNS → SQS → RDS → EventBridge → SQS) y actualiza el estado en DynamoDB a "completed".
servers:
  - url: https://{apiId}.execute-api.{region}.amazonaws.com/{stage}
    description: API Gateway desplegada
    variables:
      apiId:
        default: q6pljavrk0
      region:
        default: us-east-1
        enum: [us-east-1, us-west-2, sa-east-1, eu-west-1, eu-central-1, ap-south-1]
      stage:
        default: dev

tags:
  - name: Citas
    description: Operaciones de creación y consulta de citas

paths:
  /citas:
    post:
      tags: [Citas]
      operationId: crearCita
      summary: Crea una nueva cita (estado inicial "pending")
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CrearCitaRequest'
            examples:
              ejemplo:
                value:
                  aseguradoId: "01234"
                  scheduleId: 100
                  paisISO: "PE"
      responses:
        '201':
          description: Cita creada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cita'
              examples:
                ejemplo:
                  value:
                    citaUuid: "8b2c1f2e-7c24-4a5a-9b4c-6d2e7b1a1b01"
                    aseguradoId: "01234"
                    scheduleId: 100
                    paisISO: "PE"
                    estado: "pending"
                    fechaCreacion: "2025-09-13T14:12:00.000Z"
        '400':
          description: Error de validación
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                faltanCampos:
                  value: { error: "aseguradoId, scheduleId y paisISO son requeridos" }
        '500':
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /citas/{aseguradoId}:
    get:
      tags: [Citas]
      operationId: listarPorAsegurado
      summary: Lista las citas de un asegurado
      parameters:
        - in: path
          name: aseguradoId
          required: true
          description: Código del asegurado (5 dígitos, con ceros a la izquierda si aplica)
          schema:
            type: string
            pattern: '^\d{5}$'
          example: "01234"
      responses:
        '200':
          description: Lista de citas del asegurado
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Cita'
              examples:
                ejemplo:
                  value:
                    - citaUuid: "8b2c1f2e-7c24-4a5a-9b4c-6d2e7b1a1b01"
                      aseguradoId: "01234"
                      scheduleId: 100
                      paisISO: "PE"
                      estado: "completed"
                      fechaCreacion: "2025-09-13T14:12:00.000Z"
        '400':
          description: Error de validación de parámetros
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalido:
                  value: { error: "aseguradoId requerido" }
        '500':
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    CrearCitaRequest:
      type: object
      required: [aseguradoId, scheduleId, paisISO]
      properties:
        aseguradoId:
          type: string
          description: Código del asegurado (5 dígitos)
          pattern: '^\d{5}$'
          example: "01234"
        scheduleId:
          type: integer
          description: Identificador del espacio a agendar
          example: 100
        paisISO:
          type: string
          description: Identificador de país
          enum: [PE, CL]
          example: PE

    Cita:
      type: object
      required:
        - citaUuid
        - aseguradoId
        - scheduleId
        - paisISO
        - estado
        - fechaCreacion
      properties:
        citaUuid:
          type: string
          format: uuid
          description: Identificador único de la cita
          example: "8b2c1f2e-7c24-4a5a-9b4c-6d2e7b1a1b01"
        aseguradoId:
          type: string
          description: Código del asegurado (5 dígitos)
          pattern: '^\d{5}$'
          example: "01234"
        scheduleId:
          type: integer
          description: Identificador del espacio a agendar
          example: 100
        paisISO:
          type: string
          description: Código de país ISO
          enum: [PE, CL]
          example: PE
        estado:
          type: string
          description: Estado de la cita
          enum: [pending, completed]
          example: pending
        fechaCreacion:
          type: string
          format: date-time
          description: Fecha de creación en ISO 8601 (UTC)
          example: "2025-09-13T14:12:00.000Z"

    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
